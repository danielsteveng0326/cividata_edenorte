{% extends 'navbar.html' %}
{% load static %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0"><i class="fas fa-check-circle mr-2 text-success"></i>Contraseña Reseteada</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'login:lista_usuarios' %}">Usuarios</a></li>
                    <li class="breadcrumb-item active">Contraseña Reseteada</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card card-success">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-check-circle mr-2"></i>Contraseña Reseteada Exitosamente</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <h5><i class="icon fas fa-check"></i> ¡Operación Exitosa!</h5>
                            La contraseña del usuario <strong>{{ usuario.get_full_name }}</strong> ha sido reseteada correctamente.
                        </div>

                        <div class="info-box bg-light">
                            <span class="info-box-icon bg-info"><i class="fas fa-user"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Usuario</span>
                                <span class="info-box-number">{{ usuario.get_full_name }}</span>
                                <small>{{ usuario.email }}</small>
                            </div>
                        </div>

                        {% if email_enviado %}
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-envelope"></i> Correo Enviado</h5>
                            Se ha enviado un correo electrónico a <strong>{{ usuario.email }}</strong> con la nueva contraseña temporal.
                            El usuario deberá cambiarla en su próximo inicio de sesión.
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <h5><i class="icon fas fa-exclamation-triangle"></i> Correo No Enviado</h5>
                            No se pudo enviar el correo electrónico automáticamente. Por favor, copia la contraseña temporal a continuación y envíala manualmente al usuario.
                        </div>
                        {% endif %}

                        <div class="card card-outline card-primary">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-key mr-2"></i>Contraseña Temporal Generada</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Nueva Contraseña Temporal:</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-lg" id="password-field" value="{{ password_temporal }}" readonly style="font-family: monospace; font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; background-color: #f8f9fa;">
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" type="button" onclick="copiarPassword()">
                                                <i class="fas fa-copy mr-2"></i>Copiar
                                            </button>
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Esta contraseña es temporal y el usuario deberá cambiarla en su próximo inicio de sesión.
                                    </small>
                                </div>

                                <div class="alert alert-info mb-0">
                                    <strong><i class="fas fa-user-lock mr-2"></i>Credenciales de Acceso:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Usuario:</strong> {{ usuario.username }}</li>
                                        <li><strong>Contraseña:</strong> {{ password_temporal }}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        {% if not email_enviado %}
                        <div class="callout callout-warning">
                            <h5><i class="fas fa-paper-plane mr-2"></i>Instrucciones para el Usuario</h5>
                            <p>Por favor, envía las siguientes instrucciones al usuario:</p>
                            <div class="bg-light p-3 rounded" style="font-family: monospace;">
                                Hola {{ usuario.get_full_name }},<br><br>
                                Tu contraseña ha sido reseteada por un administrador del sistema.<br><br>
                                <strong>Tus nuevas credenciales son:</strong><br>
                                Usuario: {{ usuario.username }}<br>
                                Contraseña temporal: {{ password_temporal }}<br><br>
                                Por seguridad, deberás cambiar esta contraseña en tu próximo inicio de sesión.<br><br>
                                Si no solicitaste este cambio, contacta inmediatamente al administrador del sistema.<br><br>
                                Saludos,<br>
                                Equipo CiviData
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="card-footer">
                        <a href="{% url 'login:detalle_usuario' usuario.id %}" class="btn btn-primary">
                            <i class="fas fa-user mr-2"></i>Ver Perfil del Usuario
                        </a>
                        <a href="{% url 'login:lista_usuarios' %}" class="btn btn-secondary">
                            <i class="fas fa-list mr-2"></i>Volver a Lista de Usuarios
                        </a>
                        <button type="button" class="btn btn-success float-right" onclick="copiarCredenciales()">
                            <i class="fas fa-copy mr-2"></i>Copiar Credenciales Completas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
function copiarPassword() {
    const passwordField = document.getElementById('password-field');
    passwordField.select();
    passwordField.setSelectionRange(0, 99999); // Para móviles
    
    navigator.clipboard.writeText(passwordField.value).then(function() {
        // Mostrar notificación de éxito
        Swal.fire({
            icon: 'success',
            title: '¡Copiado!',
            text: 'Contraseña copiada al portapapeles',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
        });
    }, function(err) {
        alert('Error al copiar: ' + err);
    });
}

function copiarCredenciales() {
    const credenciales = `Usuario: {{ usuario.username }}\nContraseña: {{ password_temporal }}`;
    
    navigator.clipboard.writeText(credenciales).then(function() {
        Swal.fire({
            icon: 'success',
            title: '¡Copiado!',
            text: 'Credenciales copiadas al portapapeles',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
        });
    }, function(err) {
        alert('Error al copiar: ' + err);
    });
}
</script>
{% endblock %}
