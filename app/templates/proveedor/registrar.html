{% extends "navbar.html" %}
{% load static %}

{% block title %}Registrar Proveedor{% endblock %}

{% block content %}
<!-- Content Header -->
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">Registrar Nuevo Proveedor</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'proveedor:index' %}">Proveedores</a></li>
            <li class="breadcrumb-item active">Registrar</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <!-- Formulario principal -->
        <div class="col-md-8">
          <div class="card card-success">
            <div class="card-header">
              <h3 class="card-title">Información del Proveedor</h3>
            </div>
            
            <form id="proveedorForm" method="post" action="{% url 'proveedor:registrar' %}">
              {% csrf_token %}
              <div class="card-body">
                
                <!-- Información básica -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="nit">NIT <span class="text-danger">*</span></label>
                      <input type="text" 
                             class="form-control" 
                             id="nit" 
                             name="nit" 
                             value="{{ form_data.nit|default:'' }}"
                             placeholder="900123456"
                             pattern="[0-9]{7,15}"
                             title="Solo números, 7-15 dígitos"
                             required>
                      <small class="form-text text-muted">Sin dígito de verificación</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="tipo_empresa">Tipo de Proveedor <span class="text-danger">*</span></label>
                      <select class="form-control" id="tipo_empresa" name="tipo_empresa" required>
                        <option value="">Selecciona el tipo</option>
                        <option value="PERSONA NATURAL COLOMBIANA" {% if form_data.tipo_empresa == 'PERSONA NATURAL COLOMBIANA' %}selected{% endif %}>
                          Persona Natural Colombiana
                        </option>
                        <option value="PERSONA JURÍDICA" {% if form_data.tipo_empresa == 'PERSONA JURÍDICA' %}selected{% endif %}>
                          Persona Jurídica
                        </option>
                      </select>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="nombre">Nombre/Razón Social <span class="text-danger">*</span></label>
                  <input type="text" 
                         class="form-control" 
                         id="nombre" 
                         name="nombre" 
                         value="{{ form_data.nombre|default:'' }}"
                         placeholder="Nombre completo o razón social"
                         required>
                </div>
                
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="telefono">Teléfono</label>
                      <input type="tel" 
                             class="form-control" 
                             id="telefono" 
                             name="telefono" 
                             value="{{ form_data.telefono|default:'' }}"
                             placeholder="3001234567">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="correo">Correo Electrónico</label>
                      <input type="email" 
                             class="form-control" 
                             id="correo" 
                             name="correo" 
                             value="{{ form_data.correo|default:'' }}"
                             placeholder="correo@empresa.com">
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="direccion">Dirección</label>
                  <textarea class="form-control" 
                           id="direccion" 
                           name="direccion" 
                           rows="2" 
                           placeholder="Dirección completa">{{ form_data.direccion|default:'' }}</textarea>
                </div>
                
                <!-- Información de representante legal -->
                <div id="representanteLegalSection" style="display: none;">
                  <hr>
                  <h5>Información del Representante Legal</h5>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="nombre_representante_legal">Nombre Representante Legal</label>
                        <input type="text" 
                               class="form-control representante-field" 
                               id="nombre_representante_legal" 
                               name="nombre_representante_legal" 
                               value="{{ form_data.nombre_representante_legal|default:'' }}"
                               placeholder="Nombre completo">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="numero_doc_representante_legal">Número de Documento</label>
                        <input type="text" 
                               class="form-control representante-field" 
                               id="numero_doc_representante_legal" 
                               name="numero_doc_representante_legal" 
                               value="{{ form_data.numero_doc_representante_legal|default:'' }}"
                               placeholder="Número de cédula">
                      </div>
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="telefono_representante_legal">Teléfono Rep. Legal</label>
                        <input type="tel" 
                               class="form-control" 
                               id="telefono_representante_legal" 
                               name="telefono_representante_legal" 
                               value="{{ form_data.telefono_representante_legal|default:'' }}"
                               placeholder="3001234567">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="correo_representante_legal">Correo Rep. Legal</label>
                        <input type="email" 
                               class="form-control" 
                               id="correo_representante_legal" 
                               name="correo_representante_legal" 
                               value="{{ form_data.correo_representante_legal|default:'' }}"
                               placeholder="representante@empresa.com">
                      </div>
                    </div>
                  </div>
                </div>
                
              </div>
              
              <div class="card-footer">
                <button type="submit" class="btn btn-success btn-lg mr-2" id="btnRegistrar">
                  Registrar Proveedor
                </button>
                <a href="{% url 'proveedor:index' %}" class="btn btn-secondary">
                  Cancelar
                </a>
              </div>
            </form>
          </div>
        </div>
        
        <!-- Sidebar con ayuda -->
        <div class="col-md-4">
          <div class="card card-info">
            <div class="card-header">
              <h3 class="card-title">Ayuda</h3>
            </div>
            <div class="card-body">
              <h6>Campos Requeridos</h6>
              <ul>
                <li><strong>Nombre:</strong> Razón social completa</li>
                <li><strong>NIT:</strong> Sin dígito de verificación</li>
                <li><strong>Tipo de Empresa:</strong> Selecciona el tipo correcto</li>
              </ul>
              
              <h6 class="mt-3">Representante Legal</h6>
              <p class="text-sm">
                Se requiere información del representante legal solo para empresas 
                (todos los tipos excepto Persona Natural Colombiana).
              </p>
              
              <div class="alert alert-warning">
                <h6>Importante</h6>
                <p class="mb-0">
                  Verifica que el NIT no exista ya en el sistema. 
                  Un NIT duplicado causará error al registrar.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
  </section>

<!-- Scripts -->
<script src="{% static 'lib/adminlt320/plugins/jquery/jquery.min.js' %}"></script>
<script src="{% static 'lib/bootstrap533dist/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'lib/adminlt320/dist/js/adminlte.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

<script>
$(document).ready(function() {
    // Configurar toastr
    toastr.options = {
        "closeButton": true,
        "timeOut": "5000"
    };
    
    // Manejar cambio de tipo de empresa
    $('#tipo_empresa').on('change', function() {
        const tipoEmpresa = $(this).val();
        const representanteSection = $('#representanteLegalSection');
        const representanteFields = $('.representante-field');
        
        if (tipoEmpresa === 'PERSONA NATURAL COLOMBIANA') {
            representanteSection.slideUp();
            representanteFields.prop('required', false);
            toastr.info('Para personas naturales no se requiere información de representante legal');
        } else if (tipoEmpresa) {
            representanteSection.slideDown();
            representanteFields.prop('required', true);
            toastr.info('Para empresas es obligatorio registrar la información del representante legal');
        } else {
            representanteSection.slideUp();
            representanteFields.prop('required', false);
        }
    });
    
    // Validar NIT en tiempo real
    $('#nit').on('input', function() {
        var nit = $(this).val().replace(/[^0-9]/g, '');
        $(this).val(nit);
        
        if (nit.length > 0 && (nit.length < 7 || nit.length > 15)) {
            $(this).addClass('is-invalid');
            if (!$(this).next('.invalid-feedback').length) {
                $(this).after('<div class="invalid-feedback">NIT debe tener entre 7 y 15 dígitos</div>');
            }
        } else {
            $(this).removeClass('is-invalid');
            $(this).next('.invalid-feedback').remove();
        }
    });
    
    // Validar formulario antes de enviar
    $('#proveedorForm').on('submit', function(e) {
        var isValid = true;
        
        // Validar NIT
        var nit = $('#nit').val().trim();
        if (!nit || !/^\d{7,15}$/.test(nit)) {
            $('#nit').addClass('is-invalid');
            toastr.error('NIT inválido. Solo números, 7-15 dígitos');
            isValid = false;
        }
        
        // Validar nombre
        var nombre = $('#nombre').val().trim();
        if (!nombre || nombre.length < 3) {
            $('#nombre').addClass('is-invalid');
            toastr.error('El nombre debe tener al menos 3 caracteres');
            isValid = false;
        }
        
        // Validar tipo de empresa
        var tipoEmpresa = $('#tipo_empresa').val();
        if (!tipoEmpresa) {
            $('#tipo_empresa').addClass('is-invalid');
            toastr.error('Selecciona el tipo de empresa');
            isValid = false;
        }
        
        // Validar representante legal si es requerido
        if (tipoEmpresa && tipoEmpresa !== 'PERSONA NATURAL COLOMBIANA') {
            var nombreRep = $('#nombre_representante_legal').val().trim();
            if (!nombreRep) {
                $('#nombre_representante_legal').addClass('is-invalid');
                toastr.error('El nombre del representante legal es requerido');
                isValid = false;
            }
        }
        
        if (!isValid) {
            e.preventDefault();
            return false;
        }
        
        // Deshabilitar botón para evitar doble envío
        $('#btnRegistrar').prop('disabled', true).text('Registrando...');
    });
    
    // Quitar clase de error al escribir
    $('.form-control').on('input change', function() {
        $(this).removeClass('is-invalid');
        $(this).next('.invalid-feedback').remove();
    });
    
    // Aplicar tipo inicial si viene de parámetro GET
    var urlParams = new URLSearchParams(window.location.search);
    var nitParam = urlParams.get('nit');
    if (nitParam) {
        $('#nit').val(nitParam);
    }
    
    // Trigger inicial para tipo de empresa
    $('#tipo_empresa').trigger('change');
});
</script>
{% endblock %}