{% extends "navbar.html" %}
{% load static %}

{% block title %}Lista de Proveedores{% endblock %}

{% block content %}
<!-- Content Header -->
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">Lista de Proveedores</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'proveedor:index' %}">Proveedores</a></li>
            <li class="breadcrumb-item active">Lista</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      
      <!-- Filtros de búsqueda - SIEMPRE VISIBLE -->
      <div class="card card-default">
        <div class="card-header">
          <h3 class="card-title">Filtros de Búsqueda</h3>
        </div>
        <div class="card-body">
          <form method="get" class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label for="search">Buscar por nombre o NIT</label>
                <input type="text" 
                       class="form-control" 
                       id="search" 
                       name="search" 
                       value="{{ search }}"
                       placeholder="Nombre o NIT del proveedor">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="tipo">Tipo de Empresa</label>
                <select class="form-control" id="tipo" name="tipo">
                  <option value="">Todos los tipos</option>
                  <option value="PERSONA NATURAL COLOMBIANA" {% if tipo_filtro == 'PERSONA NATURAL COLOMBIANA' %}selected{% endif %}>
                    Persona Natural
                  </option>
                  <option value="PERSONA JURÍDICA" {% if tipo_filtro == 'PERSONA JURÍDICA' %}selected{% endif %}>
                    Persona Jurídica
                  </option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label>&nbsp;</label>
                <div>
                  <button type="submit" class="btn btn-primary mr-2">
                    Buscar
                  </button>
                  <a href="{% url 'proveedor:listar' %}" class="btn btn-secondary mr-2">
                    Limpiar
                  </a>
                  <a href="{% url 'proveedor:registrar' %}" class="btn btn-success">
                    Registrar
                  </a>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Tabla de proveedores -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            Proveedores Registrados ({{ proveedores.count }})
          </h3>
        </div>
        
        <div class="card-body">
          {% if error %}
          <div class="alert alert-danger alert-dismissible">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
            <h5>Error!</h5>
            {{ error }}
          </div>
          {% endif %}
          
          {% if proveedores %}
          <div class="table-responsive">
            <table id="proveedores-table" class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>NIT</th>
                  <th>Nombre/Razón Social</th>
                  <th>Teléfono</th>
                  <th>Correo</th>
                  <th>Ubicación</th>
                  <th>Tipo</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for proveedor in proveedores %}
                <tr>
                  <td>
                    <strong>{{ proveedor.nit }}</strong>
                  </td>
                  <td>
                    <strong>{{ proveedor.nombre }}</strong>
                    {% if proveedor.nombre_representante_legal %}
                    <br><small class="text-muted">Rep: {{ proveedor.nombre_representante_legal }}</small>
                    {% endif %}
                  </td>
                  <td>
                    {{ proveedor.telefono|default:"No disponible" }}
                    {% if proveedor.telefono_representante_legal %}
                    <br><small class="text-muted">{{ proveedor.telefono_representante_legal }}</small>
                    {% endif %}
                  </td>
                  <td>
                    {% if proveedor.correo %}
                    <a href="mailto:{{ proveedor.correo }}">{{ proveedor.correo }}</a>
                    {% else %}
                    No disponible
                    {% endif %}
                  </td>
                  <td>
                    {{ proveedor.direccion|default:"No disponible" }}
                    {% if proveedor.municipio %}
                    <br><small class="text-muted">{{ proveedor.municipio }}</small>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge badge-info">
                      {% if proveedor.tipo_empresa == 'PERSONA NATURAL COLOMBIANA' %}
                        P. Natural
                      {% elif proveedor.tipo_empresa == 'PERSONA JURÍDICA' %}
                        P. Jurídica
                      {% else %}
                        {{ proveedor.tipo_empresa }}
                      {% endif %}
                    </span>
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm">
                      <a href="{% url 'proveedor:detalle' proveedor.id %}" class="btn btn-primary btn-sm" title="Ver detalles">
                        Ver
                      </a>
                      <a href="{% url 'proveedor:detalle' proveedor.id %}" class="btn btn-secondary btn-sm" title="Editar">
                        Editar
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-info">
            <h5>Sin Resultados</h5>
            <p>No se encontraron proveedores que coincidan con los filtros aplicados.</p>
            <a href="{% url 'proveedor:registrar' %}" class="btn btn-success">
              Registrar Nuevo Proveedor
            </a>
          </div>
          {% endif %}
        </div>
        
        {% if proveedores %}
        <div class="card-footer">
          <div class="row">
            <div class="col-sm-6">
              <small class="text-muted">
                Mostrando {{ proveedores.count }} proveedor{{ proveedores.count|pluralize:"es" }}
              </small>
            </div>
            <div class="col-sm-6 text-right">
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                  Imprimir
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="exportarExcel()">
                  Exportar
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </section>
</div>

<!-- Scripts -->
<script src="{% static 'lib/adminlt320/plugins/jquery/jquery.min.js' %}"></script>
<script src="{% static 'lib/bootstrap533dist/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'lib/adminlt320/plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'lib/adminlt320/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'lib/adminlt320/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'lib/adminlt320/plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<script src="{% static 'lib/adminlt320/dist/js/adminlte.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializar DataTables si hay datos
    {% if proveedores %}
    $('#proveedores-table').DataTable({
        "responsive": true,
        "lengthChange": false,
        "autoWidth": false,
        "searching": false,  // Usamos filtros personalizados
        "paging": true,
        "pageLength": 25,
        "info": true,
        "ordering": true,
        "order": [[ 0, "asc" ]],  // Ordenar por NIT
        "language": {
            "url": "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
        }
    });
    {% endif %}
    
    // Configurar toastr
    toastr.options = {
        "closeButton": true,
        "timeOut": "3000"
    };
    
    // Focus en el campo de búsqueda
    $('#search').focus();
    
    // Función para exportar a Excel
    window.exportarExcel = function() {
        toastr.info('Función de exportar en desarrollo');
    };
    
    // Auto-submit al cambiar filtros
    $('#tipo').on('change', function() {
        if ($(this).val() !== '') {
            $(this).closest('form').submit();
        }
    });
    
    // Enter en búsqueda
    $('#search').on('keypress', function(e) {
        if (e.which === 13) {
            $(this).closest('form').submit();
        }
    });
});
</script>
{% endblock %}