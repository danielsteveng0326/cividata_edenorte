{% extends "navbar.html" %}
{% load static %}

{% block title %}Gestión de Proveedores{% endblock %}

{% block content %}
<!-- Content Header -->
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">Gestión de Proveedores</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
            <li class="breadcrumb-item active">Proveedores</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <!-- Formulario de consulta por NIT -->
        <div class="col-md-8">
          <div class="card card-primary">
            <div class="card-header">
              <h3 class="card-title">Consultar Proveedor por NIT</h3>
            </div>
            <div class="card-body">
              <form id="consultaNitForm" method="post" action="{% url 'proveedor:consultar_nit' %}">
                {% csrf_token %}
                <div class="form-group">
                  <label for="nit">Número de Identificación Tributaria (NIT)</label>
                  <div class="input-group">
                    <input type="text" 
                           class="form-control" 
                           id="nit" 
                           name="nit" 
                           placeholder="Ej: 900123456"
                           pattern="[0-9]+"
                           title="Solo números"
                           required>
                    <div class="input-group-append">
                      <button class="btn btn-primary" type="submit" id="btnConsultar">
                        Consultar
                      </button>
                    </div>
                  </div>
                  <small class="form-text text-muted">
                    Ingresa el NIT sin dígito de verificación, solo números
                  </small>
                </div>
              </form>
              
              <!-- Área de resultados -->
              <div id="resultadosArea" style="display: none;">
                <hr>
                <div id="resultadoConsulta"></div>
              </div>
              
              <!-- Loading spinner -->
              <div id="loadingSpinner" style="display: none;">
                <hr>
                <div class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Consultando...</span>
                  </div>
                  <p class="mt-2">Consultando información del proveedor...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Acciones rápidas -->
        <div class="col-md-4">
          <div class="card card-success">
            <div class="card-body text-center">
              <h5>Registro Manual</h5>
              <p class="text-muted">¿El proveedor no fue encontrado?</p>
              <a href="{% url 'proveedor:registrar' %}" class="btn btn-success">
                Registrar Nuevo Proveedor
              </a>
            </div>
          </div>
          
          <div class="card card-info">
            <div class="card-body text-center">
              <h5>Proveedores Registrados</h5>
              <p class="text-muted">Consulta todos los proveedores</p>
              <a href="{% url 'proveedor:listar' %}" class="btn btn-info">
                Ver Proveedores
              </a>
            </div>
          </div>
        </div>
      </div>
  </section>

<!-- Modal para proveedor no encontrado -->
<div class="modal fade" id="proveedorNoEncontradoModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h4 class="modal-title">
          Proveedor No Encontrado
        </h4>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>El proveedor con NIT <strong id="nitNoEncontrado"></strong> no fue encontrado en la API.</p>
        <p>¿Deseas registrarlo manualmente?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <a href="#" id="btnRegistrarManual" class="btn btn-success">
          Registrar Proveedor
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="{% static 'lib/adminlt320/plugins/jquery/jquery.min.js' %}"></script>
<script src="{% static 'lib/bootstrap533dist/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'lib/adminlt320/dist/js/adminlte.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

<script>
$(document).ready(function() {
    // Configurar toastr
    toastr.options = {
        "closeButton": true,
        "timeOut": "5000"
    };
    
    // Manejar envío del formulario
    $('#consultaNitForm').on('submit', function(e) {
        e.preventDefault();
        
        var nit = $('#nit').val().trim();
        
        // Validaciones básicas
        if (!nit) {
            toastr.error('Por favor ingresa un NIT');
            return;
        }
        
        if (!/^\d{7,15}$/.test(nit)) {
            toastr.error('NIT inválido. Solo números, 7-15 dígitos');
            return;
        }
        
        // Mostrar loading
        $('#loadingSpinner').show();
        $('#resultadosArea').hide();
        $('#btnConsultar').prop('disabled', true).text('Consultando...');
        
        // Realizar consulta AJAX
        $.ajax({
            url: $(this).attr('action'),
            method: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                $('#loadingSpinner').hide();
                $('#btnConsultar').prop('disabled', false).text('Consultar');
                
                if (response.success) {
                    if (response.existe_local) {
                        // Proveedor existe localmente
                        $('#resultadoConsulta').html(`
                            <div class="alert alert-success">
                                <h6>Proveedor encontrado en el sistema</h6>
                                <p><strong>Nombre:</strong> ${response.proveedor.nombre}</p>
                                <p><strong>NIT:</strong> ${response.proveedor.nit}</p>
                                <p><strong>Teléfono:</strong> ${response.proveedor.telefono || 'No disponible'}</p>
                                <a href="${response.detalle_url}" class="btn btn-primary btn-sm">Ver Detalles</a>
                            </div>
                        `);
                    } else if (response.api_data) {
                        // Proveedor encontrado en API
                        var apiData = response.api_data;
                        $('#resultadoConsulta').html(`
                            <div class="alert alert-info">
                                <h6>Proveedor encontrado en API</h6>
                                <p><strong>Nombre:</strong> ${apiData.nombre}</p>
                                <p><strong>NIT:</strong> ${apiData.nit}</p>
                                <p><strong>Teléfono:</strong> ${apiData.telefono || 'No disponible'}</p>
                                <button class="btn btn-success btn-sm" onclick="registrarDesdeAPI('${nit}')">
                                    Registrar en Sistema
                                </button>
                            </div>
                        `);
                    }
                    $('#resultadosArea').show();
                } else {
                    // Proveedor no encontrado
                    $('#nitNoEncontrado').text(nit);
                    $('#btnRegistrarManual').attr('href', '{% url "proveedor:registrar" %}?nit=' + nit);
                    $('#proveedorNoEncontradoModal').modal('show');
                    toastr.warning(response.error || 'Proveedor no encontrado');
                }
            },
            error: function() {
                $('#loadingSpinner').hide();
                $('#btnConsultar').prop('disabled', false).text('Consultar');
                toastr.error('Error en la consulta. Inténtalo de nuevo.');
            }
        });
    });
    
    // Función para registrar desde API
    window.registrarDesdeAPI = function(nit) {
        toastr.info('Registrando proveedor desde API...');
        
        $.ajax({
            url: '{% url "proveedor:registrar" %}',
            method: 'POST',
            data: {
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val(),
                'nit': nit,
                'desde_api': 'true'
            },
            success: function(response) {
                if (response.success) {
                    toastr.success('Proveedor registrado exitosamente');
                    window.location.href = response.redirect_url;
                } else {
                    toastr.error(response.error || 'Error al registrar');
                }
            },
            error: function() {
                toastr.error('Error al registrar proveedor');
            }
        });
    };
});
</script>
{% endblock %}