{% extends 'navbar.html' %}

{% block content %}
<!-- Content Header (Page header) -->
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0">Dashboard de Contrataci√≥n</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
          <li class="breadcrumb-item active">Dashboard</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- Main content -->
<section class="content">
  <div class="container-fluid">
    <!-- Small boxes (Stat box) -->
    <div class="row">
      <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
          <div class="inner">
            <h3>{{ numero_de_registros }}</h3>
            <p>Contratos Registrados</p>
          </div>
          <div class="icon">
            <i class="fas fa-file-contract"></i>
          </div>
          <a href="{% url 'contratos_list' %}" class="small-box-footer">Ver detalle <i class="fas fa-arrow-circle-right"></i></a>
        </div>
      </div>

      <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
          <div class="inner">
            <h3>{{ suma_valor_del_contrato }}<sup style="font-size: 20px"></sup></h3>
            <p>Valor Total (Millones)</p>
          </div>
          <div class="icon">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <a href="{% url 'contratos_list' %}" class="small-box-footer">M√°s informaci√≥n <i class="fas fa-arrow-circle-right"></i></a>
        </div>
      </div>

      <div class="col-lg-3 col-6">
        <div class="small-box bg-warning">
          <div class="inner">
            <h3>{{ numero_de_proveedores }}</h3>
            <p>Proveedores</p>
          </div>
          <div class="icon">
            <i class="fas fa-users"></i>
          </div>
          <a href="{% url 'contratos_list' %}" class="small-box-footer">M√°s informaci√≥n <i class="fas fa-arrow-circle-right"></i></a>
        </div>
      </div>

      <div class="col-lg-3 col-6">
        <div class="small-box bg-danger">
          <div class="inner">
            <h3>2025</h3>
            <p>A√±o Vigente</p>
          </div>
          <div class="icon">
            <i class="fas fa-calendar-alt"></i>
          </div>
          <a href="{% url 'contratos_list' %}" class="small-box-footer">M√°s informaci√≥n <i class="fas fa-arrow-circle-right"></i></a>
        </div>
      </div>
    </div>

    <!-- Gr√°ficos principales -->
    <div class="row">
      <!-- Gr√°fico de contratos por mes -->
      <div class="col-md-6">
        <div class="card card-success">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-chart-bar mr-2"></i>
              N√∫mero de Contratos por Mes - 2025
            </h3>
            <div class="card-tools">
              <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
              </button>
              <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="chart">
              <canvas id="stackedBarChart" style="min-height: 300px; height: 300px; max-height: 300px; max-width: 100%;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fico de valor por mes -->
      <div class="col-md-6">
        <div class="card card-success">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-dollar-sign mr-2"></i>
              Valor Contratado por Mes - 2025
            </h3>
            <div class="card-tools">
              <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
              </button>
              <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="chart">
              <canvas id="valueBarChart" style="min-height: 300px; height: 300px; max-height: 300px; max-width: 100%;"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gr√°ficos adicionales -->
    <div class="row">
      <!-- Gr√°fico de modalidades -->
      <div class="col-md-6">
        <div class="card card-primary">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-chart-pie mr-2"></i>
              Distribuci√≥n por Modalidad de Contrataci√≥n
            </h3>
            <div class="card-tools">
              <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
              </button>
              <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="chart">
              <canvas id="modalidadesChart" style="min-height: 300px; height: 300px; max-height: 300px; max-width: 100%;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fico de tipos de contrato -->
      <div class="col-md-6">
        <div class="card card-warning">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-list mr-2"></i>
              Tipos de Contrato
            </h3>
            <div class="card-tools">
              <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
              </button>
              <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="chart">
              <canvas id="tiposChart" style="min-height: 300px; height: 300px; max-height: 300px; max-width: 100%;"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gr√°fico de departamentos -->
    <div class="row">
      <div class="col-md-12">
        <div class="card card-info">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-building mr-2"></i>
              Contratos por Departamento/Secretar√≠a
            </h3>
            <div class="card-tools">
              <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
              </button>
              <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="chart">
              <canvas id="departamentosChart" style="min-height: 400px; height: 400px; max-height: 400px; max-width: 100%;"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Chart.js desde CDN CORRECTO para evitar conflictos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Iniciando carga de gr√°ficos del dashboard...');
  
  // Verificar que Chart.js est√© disponible
  if (typeof Chart === 'undefined') {
    console.error('‚ùå Chart.js no est√° cargado');
    return;
  }
  
  console.log('‚úÖ Chart.js cargado correctamente');
  
  // Datos del backend
  const labels = {{ labels|safe }};
  const data = {{ data|safe }};
  const labels2 = {{ labels2|safe }};
  const data2 = {{ data2|safe }};
  const modalidades_labels = {{ modalidades_labels|safe }};
  const modalidades_data = {{ modalidades_data|safe }};
  const tipos_labels = {{ tipos_labels|safe }};
  const tipos_data = {{ tipos_data|safe }};
  const departamentos_labels = {{ departamentos_labels|safe }};
  const departamentos_data = {{ departamentos_data|safe }};
  
  console.log('üìä Datos recibidos:', {
    labels: labels,
    data: data,
    modalidades: modalidades_labels.length,
    tipos: tipos_labels.length,
    departamentos: departamentos_labels.length
  });

  // ===============================
  // PALETA DE COLORES INSTITUCIONAL
  // ===============================
  
  // Paleta principal: Azules institucionales
  const institutionalBlue = {
    primary: '#1e3a8a',      // Azul institucional principal
    secondary: '#3b82f6',     // Azul medio
    light: '#60a5fa',        // Azul claro
    dark: '#1e40af',         // Azul oscuro
    accent: '#2563eb'        // Azul de acento
  };
  
  // Paleta secundaria: Grises corporativos
  const corporateGray = {
    primary: '#374151',      // Gris principal
    secondary: '#6b7280',    // Gris medio
    light: '#9ca3af',       // Gris claro
    dark: '#1f2937',        // Gris oscuro
    accent: '#4b5563'       // Gris de acento
  };
  
  // Paleta extendida para m√∫ltiples elementos
  const professionalPalette = [
    '#1e3a8a', '#3b82f6', '#60a5fa', '#2563eb', '#1d4ed8',
    '#374151', '#6b7280', '#4b5563', '#9ca3af', '#d1d5db',
    '#0f172a', '#475569', '#64748b', '#94a3b8', '#cbd5e1'
  ];
  
  // Paleta con transparencia para backgrounds
  const transparentPalette = [
    'rgba(30, 58, 138, 0.8)',   // Azul institucional
    'rgba(59, 130, 246, 0.8)',  // Azul medio  
    'rgba(96, 165, 250, 0.8)',  // Azul claro
    'rgba(37, 99, 235, 0.8)',   // Azul de acento
    'rgba(29, 78, 216, 0.8)',   // Azul intenso
    'rgba(55, 65, 81, 0.8)',    // Gris principal
    'rgba(107, 114, 128, 0.8)', // Gris medio
    'rgba(75, 85, 99, 0.8)',    // Gris de acento
    'rgba(156, 163, 175, 0.8)', // Gris claro
    'rgba(209, 213, 219, 0.8)'  // Gris muy claro
  ];

  // Diccionario para traducir meses
  const mesesEspanol = {
    'January': 'Enero', 'February': 'Febrero', 'March': 'Marzo',
    'April': 'Abril', 'May': 'Mayo', 'June': 'Junio',
    'July': 'Julio', 'August': 'Agosto', 'September': 'Septiembre',
    'October': 'Octubre', 'November': 'Noviembre', 'December': 'Diciembre'
  };
  
  function traducirFecha(fecha) {
    const partes = fecha.split(' ');
    const mes = partes[0];
    return mesesEspanol[mes] || mes;
  }

  // Configuraci√≥n com√∫n mejorada para todos los gr√°ficos
  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top',
        labels: {
          font: {
            family: 'Arial, sans-serif',
            size: 12
          },
          color: corporateGray.dark,
          usePointStyle: true,
          padding: 20
        }
      }
    },
    elements: {
      bar: {
        borderRadius: 4,
        borderSkipped: false,
      }
    }
  };

  // 1. GR√ÅFICO DE CONTRATOS POR MES - Estilo Institucional
  try {
    const ctxCount = document.getElementById('stackedBarChart').getContext('2d');
    new Chart(ctxCount, {
      type: 'bar',
      data: {
        labels: labels.map(fecha => traducirFecha(fecha)),
        datasets: [{
          label: 'Contratos 2025',
          data: data,
          backgroundColor: institutionalBlue.primary,
          borderColor: institutionalBlue.dark,
          borderWidth: 1,
          hoverBackgroundColor: institutionalBlue.secondary,
          hoverBorderColor: institutionalBlue.accent
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { 
              stepSize: 10,
              font: { size: 11 },
              color: corporateGray.secondary
            },
            grid: {
              color: 'rgba(156, 163, 175, 0.3)',
              drawBorder: false
            }
          },
          x: {
            ticks: { 
              maxRotation: 45, 
              minRotation: 45,
              font: { size: 11 },
              color: corporateGray.secondary
            },
            grid: {
              display: false
            }
          }
        },
        plugins: {
          ...commonOptions.plugins,
          title: {
            display: true,
            text: 'Contratos por Mes - A√±o 2025',
            font: {
              size: 16,
              weight: 'bold'
            },
            color: corporateGray.dark,
            padding: 20
          }
        }
      }
    });
    console.log('‚úÖ Gr√°fico de contratos por mes creado');
  } catch (error) {
    console.error('‚ùå Error creando gr√°fico de contratos:', error);
  }

  // 2. GR√ÅFICO DE VALOR POR MES - Estilo Corporativo
  try {
    const ctxValue = document.getElementById('valueBarChart').getContext('2d');
    new Chart(ctxValue, {
      type: 'bar',
      data: {
        labels: labels2.map(fecha => traducirFecha(fecha)),
        datasets: [{
          label: 'Valor Contratado (Millones)',
          data: data2,
          backgroundColor: institutionalBlue.secondary,
          borderColor: institutionalBlue.primary,
          borderWidth: 1,
          hoverBackgroundColor: institutionalBlue.light,
          hoverBorderColor: institutionalBlue.accent
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '$ ' + value.toLocaleString('es-CO') + ' M';
              },
              font: { size: 11 },
              color: corporateGray.secondary
            },
            grid: {
              color: 'rgba(156, 163, 175, 0.3)',
              drawBorder: false
            }
          },
          x: {
            ticks: { 
              maxRotation: 45, 
              minRotation: 45,
              font: { size: 11 },
              color: corporateGray.secondary
            },
            grid: {
              display: false
            }
          }
        },
        plugins: {
          ...commonOptions.plugins,
          title: {
            display: true,
            text: 'Valor Total Contratado por Mes - A√±o 2025',
            font: {
              size: 16,
              weight: 'bold'
            },
            color: corporateGray.dark,
            padding: 20
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let value = context.raw;
                return `$ ${value.toLocaleString('es-CO')} millones`;
              }
            },
            backgroundColor: 'rgba(30, 58, 138, 0.9)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: institutionalBlue.accent,
            borderWidth: 1
          }
        }
      }
    });
    console.log('‚úÖ Gr√°fico de valor por mes creado');
  } catch (error) {
    console.error('‚ùå Error creando gr√°fico de valor:', error);
  }

  // 3. GR√ÅFICO DE MODALIDADES - Estilo Elegante
  try {
    const ctxModalidades = document.getElementById('modalidadesChart').getContext('2d');
    new Chart(ctxModalidades, {
      type: 'doughnut',
      data: {
        labels: modalidades_labels,
        datasets: [{
          data: modalidades_data,
          backgroundColor: [
            institutionalBlue.primary,   // Azul institucional principal
            institutionalBlue.secondary, // Azul medio
            institutionalBlue.light,     // Azul claro
            corporateGray.primary,       // Gris principal
            corporateGray.secondary,     // Gris medio
            institutionalBlue.dark       // Azul oscuro
          ],
          borderWidth: 3,
          borderColor: '#ffffff',
          hoverBorderWidth: 4,
          hoverBorderColor: '#ffffff'
        }]
      },
      options: {
        ...commonOptions,
        cutout: '60%', // Hace el donut m√°s elegante
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true,
              font: {
                size: 12,
                family: 'Arial, sans-serif'
              },
              color: corporateGray.dark,
              generateLabels: function(chart) {
                const original = Chart.defaults.plugins.legend.labels.generateLabels;
                const labels = original.call(this, chart);
                labels.forEach(label => {
                  label.pointStyle = 'circle';
                });
                return labels;
              }
            }
          },
          title: {
            display: true,
            text: 'Distribuci√≥n por Modalidad',
            font: {
              size: 16,
              weight: 'bold'
            },
            color: corporateGray.dark,
            padding: 20
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((context.raw / total) * 100).toFixed(1);
                return context.label + ': ' + context.raw + ' (' + percentage + '%)';
              }
            },
            backgroundColor: 'rgba(30, 58, 138, 0.9)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: institutionalBlue.accent,
            borderWidth: 1
          }
        }
      }
    });
    console.log('‚úÖ Gr√°fico de modalidades creado');
  } catch (error) {
    console.error('‚ùå Error creando gr√°fico de modalidades:', error);
  }

  // 4. GR√ÅFICO DE TIPOS DE CONTRATO - Paleta Profesional
  try {
    const ctxTipos = document.getElementById('tiposChart').getContext('2d');
    
    // Generar colores graduales para los tipos
    const tiposColors = tipos_labels.map((_, index) => {
      const intensity = 0.8 - (index * 0.1); // Degradado de intensidad
      return `rgba(30, 58, 138, ${Math.max(intensity, 0.3)})`;
    });
    
    const tiposBorderColors = tipos_labels.map((_, index) => {
      const intensity = 1.0 - (index * 0.1);
      return `rgba(30, 58, 138, ${Math.max(intensity, 0.5)})`;
    });

    new Chart(ctxTipos, {
      type: 'bar',
      data: {
        labels: tipos_labels,
        datasets: [{
          label: 'Cantidad de Contratos',
          data: tipos_data,
          backgroundColor: tiposColors,
          borderColor: tiposBorderColors,
          borderWidth: 1,
          hoverBackgroundColor: tipos_labels.map(() => institutionalBlue.secondary),
          hoverBorderColor: tipos_labels.map(() => institutionalBlue.accent)
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { 
              stepSize: 1,
              font: { size: 11 },
              color: corporateGray.secondary
            },
            grid: {
              color: 'rgba(156, 163, 175, 0.3)',
              drawBorder: false
            }
          },
          x: {
            ticks: { 
              maxRotation: 45, 
              minRotation: 45,
              font: { size: 10 },
              color: corporateGray.secondary
            },
            grid: {
              display: false
            }
          }
        },
        plugins: {
          legend: { display: false },
          title: {
            display: true,
            text: 'Distribuci√≥n por Tipo de Contrato',
            font: {
              size: 16,
              weight: 'bold'
            },
            color: corporateGray.dark,
            padding: 20
          },
          tooltip: {
            backgroundColor: 'rgba(30, 58, 138, 0.9)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: institutionalBlue.accent,
            borderWidth: 1
          }
        }
      }
    });
    console.log('‚úÖ Gr√°fico de tipos de contrato creado');
  } catch (error) {
    console.error('‚ùå Error creando gr√°fico de tipos:', error);
  }

  // 5. GR√ÅFICO DE DEPARTAMENTOS - Estilo Polar Elegante
  try {
    const ctxDepartamentos = document.getElementById('departamentosChart').getContext('2d');
    
    // Paleta de colores institucional para departamentos
    const departmentColors = departamentos_labels.map((_, index) => {
      const colors = [
        'rgba(30, 58, 138, 0.7)',   // Azul institucional
        'rgba(59, 130, 246, 0.7)',  // Azul medio
        'rgba(96, 165, 250, 0.7)',  // Azul claro
        'rgba(55, 65, 81, 0.7)',    // Gris principal
        'rgba(107, 114, 128, 0.7)', // Gris medio
        'rgba(75, 85, 99, 0.7)',    // Gris de acento
        'rgba(37, 99, 235, 0.7)',   // Azul de acento
        'rgba(29, 78, 216, 0.7)'    // Azul intenso
      ];
      return colors[index % colors.length];
    });
    
    const departmentBorderColors = departamentos_labels.map((_, index) => {
      const colors = [
        'rgb(30, 58, 138)',   // Azul institucional
        'rgb(59, 130, 246)',  // Azul medio
        'rgb(96, 165, 250)',  // Azul claro
        'rgb(55, 65, 81)',    // Gris principal
        'rgb(107, 114, 128)', // Gris medio
        'rgb(75, 85, 99)',    // Gris de acento
        'rgb(37, 99, 235)',   // Azul de acento
        'rgb(29, 78, 216)'    // Azul intenso
      ];
      return colors[index % colors.length];
    });

    new Chart(ctxDepartamentos, {
      type: 'polarArea',
      data: {
        labels: departamentos_labels,
        datasets: [{
          data: departamentos_data,
          backgroundColor: departmentColors,
          borderColor: departmentBorderColors,
          borderWidth: 2,
          hoverBackgroundColor: departamentos_labels.map(() => 'rgba(30, 58, 138, 0.9)'),
          hoverBorderColor: departamentos_labels.map(() => institutionalBlue.accent)
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          r: {
            beginAtZero: true,
            ticks: { 
              stepSize: 5,
              font: { size: 10 },
              color: corporateGray.secondary,
              backdropColor: 'rgba(255, 255, 255, 0.8)'
            },
            grid: {
              color: 'rgba(107, 114, 128, 0.3)'
            },
            angleLines: {
              color: 'rgba(107, 114, 128, 0.3)'
            }
          }
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              usePointStyle: true,
              font: {
                size: 11,
                family: 'Arial, sans-serif'
              },
              color: corporateGray.dark
            }
          },
          title: {
            display: true,
            text: 'Contratos por Departamento/Secretar√≠a',
            font: {
              size: 16,
              weight: 'bold'
            },
            color: corporateGray.dark,
            padding: 20
          },
          tooltip: {
            backgroundColor: 'rgba(30, 58, 138, 0.9)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: institutionalBlue.accent,
            borderWidth: 1
          }
        }
      }
    });
    console.log('‚úÖ Gr√°fico de departamentos creado');
  } catch (error) {
    console.error('‚ùå Error creando gr√°fico de departamentos:', error);
  }

  console.log('üéâ Todos los gr√°ficos han sido procesados con paleta institucional');
});
</script>
{% endblock %}