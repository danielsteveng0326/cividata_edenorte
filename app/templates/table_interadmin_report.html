{% extends 'navbar.html' %}
{% load static %}

{% block content %}
<!-- Content Header -->
<section class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1><i class="fas fa-file-contract text-success mr-2"></i>Reporte de Contratos Interadministrativos</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
          <li class="breadcrumb-item active">Reporte Interadministrativos</li>
        </ol>
      </div>
    </div>
  </div>
</section>

<!-- Main content -->
<section class="content">
  <div class="container-fluid">
    
    <!-- Panel de Filtros -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-filter mr-2"></i>Filtros de Búsqueda
            </h3>
          </div>
          <div class="card-body">
            <form method="GET" action="">
              <div class="row">
                <div class="col-md-2">
                  <div class="form-group">
                    <label for="ano">Año:</label>
                    <select class="form-control" name="ano" id="ano">
                      <option value="">Todos los años</option>
                      {% for ano in anos_disponibles %}
                        <option value="{{ ano }}" {% if ano_filtro == ano|stringformat:"s" %}selected{% endif %}>{{ ano }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label for="municipio">Municipio:</label>
                    <select class="form-control" name="municipio" id="municipio">
                      <option value="">Todos los municipios</option>
                      {% for municipio in municipios_disponibles %}
                        <option value="{{ municipio }}" {% if municipio_filtro == municipio %}selected{% endif %}>
                          {{ municipio }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="col-md-5">
                  <div class="form-group">
                    <label for="busqueda">Búsqueda general:</label>
                    <input type="text" class="form-control" name="busqueda" id="busqueda" 
                           placeholder="Buscar por proceso, contrato, contratista, objeto..." 
                           value="{{ busqueda_filtro }}">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label>&nbsp;</label>
                    <div class="btn-group btn-block">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search mr-1"></i>Filtrar
                      </button>
                      <a href="{% url 'contratos_interadmin_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-eraser mr-1"></i>Limpiar
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Información de filtros aplicados -->
    {% if ano_filtro or municipio_filtro or busqueda_filtro %}
    <div class="row mb-3">
      <div class="col-12">
        <div class="alert alert-info">
          <strong><i class="fas fa-info-circle mr-1"></i>Filtros aplicados:</strong>
          <ul class="mb-0 mt-2">
            {% if ano_filtro %}
              <li><strong>Año:</strong> {{ ano_filtro }}</li>
            {% endif %}
            {% if municipio_filtro %}
              <li><strong>Municipio:</strong> {{ municipio_filtro }}</li>
            {% endif %}
            {% if busqueda_filtro %}
              <li><strong>Búsqueda:</strong> "{{ busqueda_filtro }}"</li>
            {% endif %}
          </ul>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Tabla Principal -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-list mr-2"></i>
              Lista de Contratos Interadministrativos
              {% if total_contratos %}
                <span class="badge badge-primary ml-2">{{ total_contratos }} registro{{ total_contratos|pluralize }}</span>
              {% endif %}
            </h3>
            <div class="card-tools">
              <!-- Controles de exportación -->
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-success dropdown-toggle" data-toggle="dropdown">
                  <i class="fas fa-download mr-1"></i>Exportar
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                  <a class="dropdown-item" href="#" id="export-excel">
                    <i class="fas fa-file-excel text-success mr-2"></i>Excel
                  </a>
                  <a class="dropdown-item" href="#" id="export-csv">
                    <i class="fas fa-file-csv text-info mr-2"></i>CSV
                  </a>
                  <a class="dropdown-item" href="#" id="export-pdf">
                    <i class="fas fa-file-pdf text-danger mr-2"></i>PDF
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="#" id="export-print">
                    <i class="fas fa-print text-dark mr-2"></i>Imprimir
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div class="card-body p-0">
            <div class="table-responsive">
              <table id="contratos-interadmin-table" class="table table-striped table-hover table-sm">
                <thead class="thead-dark">
                  <tr>
                    <th>Proceso N°</th>
                    <th>Contrato N°</th>
                    <th>Estado</th>
                    <th>Contratista</th>
                    <th>Municipio</th>
                    <th>Fecha Firma</th>
                    <th>Fecha Fin</th>
                    <th>Valor</th>
                    <th>Tipo</th>
                    <th>Objeto</th>
                  </tr>
                </thead>
                <tbody>
                  {% for contrato in contratos_interadmin %}
                  <tr>
                    <td>
                      <span class="font-weight-bold">{{ contrato.numero_de_proceso|default:"N/A" }}</span>
                    </td>
                    <td>{{ contrato.numero_del_contrato|default:"N/A" }}</td>
                    <td>
                      <span class="badge badge-info">{{ contrato.estado_del_proceso|default:"N/A" }}</span>
                    </td>
                    <td>{{ contrato.nom_raz_social_contratista|default:"N/A"|truncatechars:30 }}</td>
                    <td>{{ contrato.municipio_entidad|default:"N/A" }}</td>
                    <td>{{ contrato.fecha_de_firma_del_contrato|date:"d/m/Y"|default:"N/A" }}</td>
                    <td>{{ contrato.fecha_fin_ejecuci_n|date:"d/m/Y"|default:"N/A" }}</td>
                    <td class="text-right">
                      {% if contrato.valor_contrato %}
                        ${{ contrato.valor_contrato|floatformat:0 }}
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                    <td>{{ contrato.tipo_de_contrato|default:"N/A"|truncatechars:20 }}</td>
                    <td>
                      <div class="object-text" title="{{ contrato.objeto_a_contratar|default:'N/A' }}">
                        {{ contrato.objeto_a_contratar|default:"N/A" }}
                      </div>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="10" class="text-center py-4">
                      <div class="text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <h5>No se encontraron contratos interadministrativos</h5>
                        <p>No hay registros que coincidan con los filtros aplicados.</p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Footer con información -->
          <div class="card-footer">
            <div class="row">
              <div class="col-sm-6">
                <div class="dataTables_info" id="info-registros">
                  <!-- Se actualiza dinámicamente por DataTables -->
                </div>
              </div>
              <div class="col-sm-6 text-right">
                <small class="text-muted">
                  <i class="fas fa-info-circle mr-1"></i>
                  Última actualización: {{ now|date:"d/m/Y H:i" }}
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- CSS necesario para DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap4.min.css">

<!-- Scripts necesarios para DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>

<script>
$(document).ready(function() {
    console.log('🚀 Inicializando DataTable para contratos interadministrativos...');
    
    // Configurar opciones de exportación
    var exportOptions = {
        columns: ':visible:not(.no-export)',
        modifier: {
            page: 'all'
        }
    };
    
    // Inicializar DataTable
    var table = $('#contratos-interadmin-table').DataTable({
        dom: 'Bfrtip',
        pageLength: 25,
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json'
        },
        order: [[5, 'desc']], // Ordenar por fecha de firma descendente
        processing: false,
        serverSide: false,
        buttons: [
            {
                extend: 'copy',
                text: '<i class="fas fa-copy mr-1"></i>Copiar',
                className: 'btn btn-sm btn-outline-secondary d-none',
                exportOptions: exportOptions
            },
            {
                extend: 'csv',
                text: '<i class="fas fa-file-csv mr-1"></i>CSV',
                className: 'btn btn-sm btn-outline-info d-none',
                filename: 'contratos_interadministrativos_' + new Date().toISOString().split('T')[0],
                exportOptions: exportOptions
            },
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel mr-1"></i>Excel',
                className: 'btn btn-sm btn-outline-success d-none',
                filename: 'contratos_interadministrativos_' + new Date().toISOString().split('T')[0],
                title: 'Reporte de Contratos Interadministrativos - ' + new Date().toLocaleDateString(),
                exportOptions: exportOptions
            },
            {
                extend: 'pdf',
                text: '<i class="fas fa-file-pdf mr-1"></i>PDF',
                className: 'btn btn-sm btn-outline-danger d-none',
                orientation: 'landscape',
                pageSize: 'A4',
                filename: 'contratos_interadministrativos_' + new Date().toISOString().split('T')[0],
                title: 'Reporte de Contratos Interadministrativos',
                exportOptions: exportOptions
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print mr-1"></i>Imprimir',
                className: 'btn btn-sm btn-outline-dark d-none',
                title: 'Reporte de Contratos Interadministrativos',
                exportOptions: exportOptions
            }
        ],
        columnDefs: [
            { targets: [7], className: 'text-right' },
            { targets: '_all', orderable: false } // Deshabilitar ordenación en TODAS las columnas excepto fecha
        ],
        drawCallback: function(settings) {
            var api = this.api();
            var info = api.page.info();
            $('#info-registros').html(
                'Mostrando ' + (info.start + 1) + ' a ' + info.end + 
                ' de ' + info.recordsDisplay + ' registros' + 
                (info.recordsTotal !== info.recordsDisplay ? 
                    ' (filtrados de ' + info.recordsTotal + ' registros totales)' : '')
            );
            
            console.log('📊 Página actualizada: Mostrando ' + (info.start + 1) + ' a ' + info.end);
        },
        initComplete: function() {
            console.log('✅ DataTable inicializado con 25 registros por página');
            console.log('📄 Total de registros: ' + this.api().page.info().recordsTotal);
        }
    });
    
    // Event listeners para exportación
    $('#export-excel').on('click', function(e) {
        e.preventDefault();
        console.log('📊 Exportando a Excel...');
        table.button('.buttons-excel').trigger();
    });
    
    $('#export-csv').on('click', function(e) {
        e.preventDefault();
        console.log('📄 Exportando a CSV...');
        table.button('.buttons-csv').trigger();
    });
    
    $('#export-pdf').on('click', function(e) {
        e.preventDefault();
        console.log('📑 Exportando a PDF...');
        table.button('.buttons-pdf').trigger();
    });
    
    $('#export-print').on('click', function(e) {
        e.preventDefault();
        console.log('🖨️ Imprimiendo...');
        table.button('.buttons-print').trigger();
    });
    
    // Manejo de errores
    $.fn.dataTable.ext.errMode = 'none';
    $('#contratos-interadmin-table').on('error.dt', function(e, settings, techNote, message) {
        console.error('❌ Error en DataTable:', message);
        alert('Error al cargar la tabla. Por favor, recarga la página.');
    });
    
    console.log('✅ Todo configurado correctamente');
});
</script>

<style>
/* Estilos básicos */
.table-responsive {
    border-radius: 0.25rem;
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
}

.table td {
    font-size: 0.875rem;
    vertical-align: middle;
}

.badge {
    font-size: 0.75rem;
}

/* Estilos específicos para la columna de objeto */
.object-text {
    max-width: 350px;
    word-wrap: break-word;
    word-break: break-word;
    white-space: normal;
    line-height: 1.4;
    padding: 4px 0;
    font-size: 0.85rem;
}

/* Hacer la tabla más responsive para el objeto */
#contratos-interadmin-table td.object-column {
    max-width: 350px;
    min-width: 250px;
}

/* Mejorar la presentación general de la tabla */
#contratos-interadmin-table {
    table-layout: auto;
}

#contratos-interadmin-table td {
    padding: 8px 6px;
}

/* Asegurar que DataTables funcione */
.dataTables_wrapper {
    width: 100%;
}

.dataTables_wrapper .dataTables_paginate {
    margin-top: 15px;
    text-align: right;
}

.dataTables_wrapper .dataTables_info {
    padding-top: 0.755em;
}

/* Responsive */
@media (max-width: 768px) {
    .card-tools .btn-group {
        width: 100%;
        margin-top: 10px;
    }
    
    .object-text {
        max-width: 200px;
        font-size: 0.8rem;
    }
}

/* Para exportación - asegurar que el texto completo se exporte */
.object-text[data-export] {
    display: none;
}
</style>
{% endblock %}